<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>เปรียบเทียบข้อความแบบไม่ตัดบรรทัด</title>
  <style>
    body {
      font-family: monospace, sans-serif;
      background: #1e1e1e;
      color: #d4d4d4;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    #compareView {
      text-align: center;
      padding: 20px;
    }

    .textarea-box {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
      width: 100%;
    }

    .editor-panel {
      background: #1e1e1e;
      padding: 0;
      border: 1px solid #3c3c3c;
      font-family: monospace;
      width: 35%; /* ปรับให้แคบลงจาก 45% */
      min-height: 300px;
      max-height: 800px;
      overflow: hidden;
      display: flex;
      flex-direction: row;
      scrollbar-width: auto;
      text-align: left;
      position: relative;
    }

    .editor-panel .line-numbers {
      padding: 10px 5px 10px 10px;
      line-height: 1.5em;
      font-size: 14px;
      background: #252526;
      color: #858585;
      text-align: right;
      user-select: none;
      overflow-y: hidden;
      white-space: pre;
      display: block !important;
      width: auto;
      min-width: 40px;
      height: 100%;
      box-sizing: border-box;
    }

    .editor-panel textarea {
      width: 100%;
      min-height: 300px;
      max-height: 800px;
      background: transparent;
      color: #d4d4d4;
      font-family: monospace;
      font-size: 14px;
      padding: 10px;
      border: none;
      resize: none;
      box-sizing: border-box;
      height: 100%;
      overflow-y: auto;
      line-height: 1.5em;
      white-space: pre;
    }

    .result-box {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .result {
      background: #1e1e1e;
      padding: 10px;
      border: 1px solid #3c3c3c;
      font-family: monospace;
      width: 35%; /* ปรับให้แคบลงจาก 45% */
      min-height: 300px;
      max-height: 800px;
      overflow-x: auto;
      overflow-y: auto;
      white-space: nowrap;
      display: flex;
      flex-direction: column;
      scrollbar-width: auto;
      text-align: left;
      outline: none;
    }

    .result::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }

    .result::-webkit-scrollbar-thumb {
      background-color: #646464;
      border-radius: 10px;
      border: 2px solid #1e1e1e;
    }

    .diff {
      background-color: #3e7f9f;
      color: #fff;
    }

    .line {
      display: flex;
      align-items: flex-start;
      min-height: 1.5em;
      line-height: 1.5em;
      font-size: 14px;
    }

    .line-number {
      text-align: right;
      color: #858585;
      user-select: none;
      padding-right: 6px;
      min-width: 40px;
      line-height: 1.5em;
    }

    .line-content {
      flex: 1;
      white-space: pre;
      line-height: 1.5em;
    }

    button {
      background-color: #007acc;
      color: #ffffff;
      border: none;
      padding: 10px 14px;
      cursor: pointer;
      font-size: 14px;
      margin: 0 5px;
      min-width: 90px;
      border-radius: 3px;
    }

    button:hover {
      background-color: #005a9e;
    }

    .button-row {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
    }

    #editorView {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 99;
      background: #1e1e1e;
      flex-direction: column;
      min-height: 100vh;
      min-width: 100vw;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #1e1e1e;
      padding: 10px 20px;
      z-index: 10;
      height: 50px;
    }

    .hint-box {
      background-color: #007acc;
      color: white;
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 3px;
      display: flex;
      align-items: center;
      height: 32px;
    }

    #backButton {
      background-color: #007acc;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      min-width: 90px;
      padding: 0 16px;
      height: 32px;
      display: flex;
      align-items: center;
    }
    #backButton:hover { background-color: #005a9e; }

    .editor-container {
      display: flex;
      flex: 1;
      min-height: 0;
      height: calc(100vh - 50px);
      overflow: hidden;
    }

    .line-numbers {
      background: #252526;
      color: #858585;
      padding: 10px 5px 10px 10px;
      text-align: right;
      user-select: none;
      overflow-y: auto;
      white-space: pre;
      line-height: 1.5em;
      font-size: 14px;
      font-family: monospace;
      flex-shrink: 0;
      height: 100%;
      box-sizing: border-box;
      display: block !important;
      width: auto;
      min-width: 40px;
    }

    .line-numbers::-webkit-scrollbar {
      display: none;
    }

    #editor {
      flex: 1;
      background: #1e1e1e;
      color: #d4d4d4;
      border: none;
      padding: 10px;
      font-family: monospace;
      font-size: 14px;
      resize: none;
      line-height: 1.5em;
      outline: none;
      white-space: pre;
      overflow-y: auto;
      box-sizing: border-box;
      height: 100%;
    }

    .line-highlight {
      position: absolute;
      left: 0;
      right: 0;
      background: rgba(0,122,204,0.25);
      border-radius: 4px;
      z-index: 2;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .textarea-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
      z-index: 2;
    }

    /* ปรับขนาดปุ่ม copy-line-btn2 ให้พอดีกับบรรทัดและไม่ล้น */
    .copy-line-btn2 {
      width: 2em !important;
      min-width: 0 !important;
      max-width: 2em !important;
      height: 1.5em;
      font-size: 1em;
      padding: 0;
      margin: 0;
      text-align: center;
      line-height: 1.5em;
      border-radius: 3px;
      position: absolute;
      left: 0;
      background: #007acc;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.15s;
      display: block;
      border-left: 4px solid #3e7f9f;
      box-shadow: 2px 0 8px -2px #000a, 0 1px 0 #2228;
      margin-right: 4px;
    }
    #copyLineBtns2 {
      width: 2em !important;
      min-width: 0 !important;
      max-width: 2em !important;
    }
    /* ซ่อนปุ่มถ้าเลยขอบล่าง result2 */
    .copy-line-btn2.hide {
      display: none !important;
    }
    #copyLineBtns2 {
      position: absolute;
      left: -8px;
      top: 0;
      width: 32px;
      pointer-events: none;
      z-index: 3;
      /* เพิ่ม overflow: hidden เพื่อไม่ให้ปุ่มเกินขอบ */
      overflow: hidden;
    }
    .copy-line-btn2 {
      pointer-events: auto;
    }
    .copy-line-btn2:hover {
  background: #005a9e;
  border-left: 4px solid #fff176;
  box-shadow: 0 0 0 2px #fff17688, 2px 0 8px -2px #000a;
  z-index: 10;
}
/* เพิ่มเอฟเฟกต์เรืองแสงแนวขวาเมื่อ hover ปุ่ม copy-line-btn2 */
.copy-line-btn2:hover,
.copy-line-btn2:focus {
  background: #005a9e;
  border-left: 4px solid #fff176;
  box-shadow: 0 0 0 2px #fff17688, 2px 0 8px -2px #000a;
  z-index: 10;
}
/* เส้นเรืองแสงแนวขวา */
.copy-line-btn2::after {
  content: "";
  position: absolute;
  left: 100%;
  top: 0;
  height: 100%;
  width: calc(100vw - 60px); /* ขยายเส้นไปทางขวาให้สุดกล่อง result2 */
  background: linear-gradient(to right, #fff17699 0%, #fff17622 100%);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.15s;
  z-index: 1;
}
.copy-line-btn2:hover::after,
.copy-line-btn2:focus::after {
  opacity: 1;
}
  </style>
</head>
<body>

<div id="compareView">
  <h2>เปรียบเทียบข้อความทีละตัว (แบบไม่ตัดบรรทัด)</h2>
  <div class="textarea-box">
    <div class="editor-panel">
      <div class="line-numbers" id="ln-text1"></div>
      <div class="textarea-overlay"></div>
      <textarea id="text1" placeholder="ข้อความต้นฉบับ (แยกบรรทัด)..."></textarea>
    </div>
    <div class="editor-panel">
      <div class="line-numbers" id="ln-text2"></div>
      <div class="textarea-overlay"></div>
      <textarea id="text2" placeholder="ข้อความแปล หรืออีกเวอร์ชัน..."></textarea>
    </div>
  </div>
  <div class="button-row">
    <button onclick="openEditor('text1')">Raw Text 1</button>
    <button onclick="openEditor('result1', true)">Raw Result 1</button>
    <button onclick="compareText()">เปรียบเทียบ</button>
    <button onclick="openEditor('text2')">Raw Text 2</button>
    <button onclick="openEditor('result2', true)">Raw Result 2</button>
  </div>
  <div class="result-box">
    <div id="result1" class="result" tabindex="0"></div>
    <div style="display:flex; flex-direction:column; align-items:flex-end; justify-content:flex-start; position:relative; min-width:32px;">
      <div id="copyLineBtns2" style="position:absolute; left:-8px; top:0; width:32px; pointer-events:none;"></div>
    </div>
    <div id="result2" class="result" tabindex="0" style="position:relative;"></div>
  </div>
  <div id="copyLineBtns" style="display:none"></div>
</div>

<div id="editorView">
  <div class="top-bar">
    <div class="hint-box">กด &nbsp; <b>Ctrl + Shift + L</b> &nbsp; เพื่อคลุมและคัดลอกทั้งบรรทัด และ เมื่อแก้ไขข้อมูลในช่องนี้จะทำการแก้ไขข้อมูลภายนอกด้วย ( Autosave )</div>
    <button id="backButton" onclick="closeEditor()">กลับ</button>
  </div>
  <div class="editor-container">
    <div id="lineNumbers" class="line-numbers"></div>
    <textarea id="editor" spellcheck="false" autocomplete="off" autocorrect="off" autocapitalize="off"></textarea>
  </div>
</div>

<script>
  // ใช้จำว่าเรากำลังแก้อันไหนอยู่
  let currentEditTarget = null;
  let isEditingResult = false;

  function escapeHtml(text) {
    return text.replace(/[&<>"]|'/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
    })[m]);
  }

  function compareText() {
    const a = document.getElementById('text1').value.split('\n');
    const b = document.getElementById('text2').value.split('\n');
    const max = Math.max(a.length, b.length);
    let r1='', r2='';

    for (let i=0; i<max; i++) {
      const l1 = a[i]||'', l2 = b[i]||'';
      const len = Math.max(l1.length, l2.length);
      let c1='', c2='';
      let diff = false;
      for (let j=0; j<len; j++) {
        const ch1 = l1[j]||' ', ch2 = l2[j]||' ';
        const e1 = escapeHtml(ch1), e2 = escapeHtml(ch2);
        if (ch1===ch2) { c1+=e1; c2+=e2; }
        else {
          c1+=`<span class="diff">${e1}</span>`;
          c2+=`<span class="diff">${e2}</span>`;
          diff = true;
        }
      }
      r1 += `<div class="line"><span class="line-number">${i+1}</span><span class="line-content">${c1}</span></div>`;
      r2 += `<div class="line"><span class="line-number">${i+1}</span><span class="line-content">${c2}</span></div>`;
    }

    document.getElementById('result1').innerHTML = r1;
    document.getElementById('result2').innerHTML = r2;

    // --- ปุ่ม copy ตรงกับบรรทัดจริง ---
    const copyBtns2Div = document.getElementById('copyLineBtns2');
    const result2 = document.getElementById('result2');

    // สร้างปุ่ม copy เฉพาะบรรทัดที่ diff
    let copyBtnsHtml = '';
    const lines = Array.from(result2.querySelectorAll('.line'));
    for (let i = 0; i < lines.length; i++) {
      const l1 = a[i] || '', l2 = b[i] || '';
      let diff = l1 !== l2;
      if (diff) {
        // เปลี่ยนจาก ⮐ เป็นเลขบรรทัด
        copyBtnsHtml += `<button class="copy-line-btn2" data-line="${i}" title="คัดลอกบรรทัด ${i + 1}">${i + 1}</button>`;
      }
    }
    copyBtns2Div.innerHTML = copyBtnsHtml;

    // จัดตำแหน่งปุ่ม copy ให้ตรงกับบรรทัดจริง
    function positionCopyBtns() {
      const result2Rect = result2.getBoundingClientRect();
      const scrollTop = result2.scrollTop;
      const visibleHeight = result2.clientHeight;
      const btns = copyBtns2Div.querySelectorAll('.copy-line-btn2');
      let btnIdx = 0;
      for (let i = 0; i < lines.length; i++) {
        const l1 = a[i] || '', l2 = b[i] || '';
        let diff = l1 !== l2;
        if (!diff) continue;
        const lineRect = lines[i].getBoundingClientRect();
        const lineTop = lines[i].offsetTop - scrollTop;
        const btn = btns[btnIdx++];
        btn.style.position = 'absolute';
        btn.style.left = '0';
        btn.style.top = lineTop + 'px';
        btn.style.width = '24px';
        btn.style.height = lines[i].offsetHeight + 'px';
        // ซ่อนถ้าอยู่นอก viewport หรือเลยขอบบน
        if (lineTop + lines[i].offsetHeight < 0 || lineTop > visibleHeight || lineTop < 0) {
  btn.classList.add('hide');
} else {
  btn.classList.remove('hide');
}
      }
      copyBtns2Div.style.height = result2.scrollHeight + 'px';
    }
    positionCopyBtns();
    result2.onscroll = positionCopyBtns;
    window.addEventListener('resize', positionCopyBtns);

    // event ปุ่ม copy
    copyBtns2Div.querySelectorAll('.copy-line-btn2').forEach(btn => {
      btn.onclick = function () {
        const idx = parseInt(this.getAttribute('data-line'));
        const text1Lines = document.getElementById('text1').value.split('\n');
        const text2Lines = document.getElementById('text2').value.split('\n');
        text2Lines[idx] = text1Lines[idx] || '';
        document.getElementById('text2').value = text2Lines.join('\n');
        compareText();
      };
    });

    addResultLineClickEvents();
  }

  const compareView = document.getElementById('compareView');
  const editorView  = document.getElementById('editorView');
  const editor      = document.getElementById('editor');
  const lineNumbers = document.getElementById('lineNumbers');

  function openEditor(id, isResult=false) {
    currentEditTarget = id;
    isEditingResult = isResult;

    let txt = '';
    if (isResult) {
      const el = document.getElementById(id);
      txt = Array.from(el.querySelectorAll('.line-content'))
                 .map(s=>s.innerText).join('\n');
    } else {
      txt = document.getElementById(id).value;
    }
    editor.value = txt;
    compareView.style.display = 'none';
    editorView.style.display  = 'flex';
    editor.scrollTop    = 0;
    lineNumbers.scrollTop = 0;
    updateLineNumbers();
  }

  function closeEditor() {
    saveEditorContent();
    editorView.style.display  = 'none';
    compareView.style.display = 'block';
  }

  function saveEditorContent() {
    const updatedText = editor.value;
    if (!currentEditTarget) return;

    if (isEditingResult) {
      const lines = updatedText.split('\n');
      let r = '';
      for (let i=0; i<lines.length; i++) {
        const line = escapeHtml(lines[i]);
        r += `<div class="line"><span class="line-number">${i+1}</span>` +
             `<span class="line-content">${line}</span></div>`;
      }
      document.getElementById(currentEditTarget).innerHTML = r;
    } else {
      document.getElementById(currentEditTarget).value = updatedText;
    }

    compareText(); // อัพเดตผลเปรียบเทียบใหม่
  }

  function updateLineNumbers() {
    const lines = editor.value.split('\n');
    let count = lines.length;
    if (count===1 && lines[0]==='') count=1;

    let txt='';
    for (let i=1; i<=count; i++) txt += i + '\n';
    lineNumbers.textContent = txt;
    lineNumbers.style.height = editor.clientHeight+'px';

    const digits = count.toString().length;
    const charW  = 8;
    const pad     = 16;
    lineNumbers.style.width = Math.max(40, digits*charW + pad) + 'px';
  }

  editor.addEventListener('scroll', () => {
    lineNumbers.scrollTop = editor.scrollTop;
  });
  editor.addEventListener('input', () => {
    updateLineNumbers();
    saveEditorContent(); // ← บันทึกอัตโนมัติระหว่างพิมพ์
  });
  window.addEventListener('resize', updateLineNumbers);

  // Ctrl+Shift+L เพื่อเลือกบรรทัด-คัดลอก สำหรับ editor
  let wasMark = false;
  editor.addEventListener('keydown', e => {
    if (e.ctrlKey && e.shiftKey && e.key.toLowerCase()==='l') {
      e.preventDefault(); wasMark = true;
      const t = editor.value;
      let s0 = editor.selectionStart, s1 = editor.selectionEnd;
      let st = t.lastIndexOf('\n', s0-1)+1;
      let en = t.indexOf('\n', s1);
      if (en===-1) en = t.length;
      while (en>st && /\s/.test(t[en-1])) en--;
      editor.setSelectionRange(st, en);
      navigator.clipboard.writeText(t.slice(st,en)).catch(()=>{});
      setTimeout(()=>{
        const nb = t.indexOf('\n', en);
        if (nb!==-1) editor.setSelectionRange(nb+1, nb+1);
        else editor.setSelectionRange(t.length, t.length);
      }, 0);
    }
    if (wasMark && e.key==='ArrowRight') {
      wasMark = false;
      const c = editor.selectionEnd;
      editor.setSelectionRange(c,c);
    }
  });

  // Ctrl+Shift+L สำหรับ textarea #text1 และ #text2
  ['text1', 'text2'].forEach(id => {
    const el = document.getElementById(id);
    el.addEventListener('keydown', e => {
      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'l') {
        e.preventDefault();
        const t = el.value;
        let s0 = el.selectionStart, s1 = el.selectionEnd;
        let st = t.lastIndexOf('\n', s0 - 1) + 1;
        let en = t.indexOf('\n', s1);
        if (en === -1) en = t.length;
        while (en > st && /\s/.test(t[en - 1])) en--;
        el.setSelectionRange(st, en);
        navigator.clipboard.writeText(t.slice(st, en)).catch(() => {});
        setTimeout(() => {
          const nb = t.indexOf('\n', en);
          if (nb !== -1) el.setSelectionRange(nb + 1, nb + 1);
          else el.setSelectionRange(t.length, t.length);
        }, 0);
      }
    });
  });

  // Ctrl+Shift+L สำหรับ div ผลลัพธ์ #result1 และ #result2
  ['result1', 'result2'].forEach(id => {
    const el = document.getElementById(id);
    el.tabIndex = 0; // ทำให้ focus ได้
    el.addEventListener('keydown', e => {
      if (e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'l') {
        e.preventDefault();
        const sel = window.getSelection();
        let line = null;

        if (sel.rangeCount > 0) {
          const anchorNode = sel.anchorNode;
          if (anchorNode) {
            line = anchorNode.closest('.line');
          }
        }

        // ถ้าไม่ได้เลือกอะไรเลย ให้เลือกแถวแรก
        if (!line) {
          const lines = el.querySelectorAll('.line');
          if (lines.length > 0) line = lines[0];
        }

        if (line) {
          const content = line.querySelector('.line-content');
          const range = document.createRange();
          range.selectNodeContents(content);
          sel.removeAllRanges();
          sel.addRange(range);

          // คัดลอกไป clipboard
          navigator.clipboard.writeText(content.innerText).catch(() => {});
        }
      }
    });
  });

  // --- เพิ่มเลขบรรทัดใน textarea-box ---
  function updateTextareaLineNumbers(id, lnId) {
    const ta = document.getElementById(id);
    const ln = document.getElementById(lnId);
    const lines = ta.value.split('\n');
    ln.innerHTML = '';
    const lineHeight = parseFloat(window.getComputedStyle(ta).lineHeight);

    for (let i = 1; i <= lines.length; i++) {
      const div = document.createElement('div');
      div.textContent = i;
      div.style.height = lineHeight + 'px';
      div.style.lineHeight = lineHeight + 'px';
      ln.appendChild(div);
    }

    // ปรับความสูงของ .line-numbers ให้เท่ากับ textarea
    ln.style.height = ta.clientHeight + 'px';

    // ปรับ scrollTop โดยคำนวณอัตราส่วน scroll
    if (ta.scrollHeight > ta.clientHeight) {
      const ratio = ta.scrollTop / (ta.scrollHeight - ta.clientHeight);
      const lnScrollHeight = ln.scrollHeight - ln.clientHeight;
      ln.scrollTop = ratio * lnScrollHeight;
    } else {
      ln.scrollTop = 0;
    }
  }
  
  ['text1', 'text2'].forEach((id, idx) => {
    const lnId = 'ln-' + id;
    const ta = document.getElementById(id);
    ta.addEventListener('input', () => updateTextareaLineNumbers(id, lnId));
    ta.addEventListener('scroll', () => updateTextareaLineNumbers(id, lnId));
    window.addEventListener('resize', () => updateTextareaLineNumbers(id, lnId));
    updateTextareaLineNumbers(id, lnId);
  });

  // --- คลิกเลขบรรทัดใน result-box เพื่อ focus textarea ---
  function focusTextareaLine(textareaId, lineNum) {
    const ta = document.getElementById(textareaId);
    const lines = ta.value.split('\n');
    let pos = 0;
    for (let i = 0; i < lineNum - 1; i++) pos += (lines[i] ? lines[i].length : 0) + 1;
    ta.focus();
    ta.setSelectionRange(pos, pos);
    // scroll ให้เห็นบรรทัดนั้น
    const lineHeight = parseInt(window.getComputedStyle(ta).lineHeight) || 20;
    ta.scrollTop = (lineNum - 1) * lineHeight;

    // เพิ่ม highlight
    showLineHighlight(textareaId, lineNum);
  }
  
  // เพิ่ม event ให้เลขบรรทัดใน result-box
  function addResultLineClickEvents() {
    ['result1', 'result2'].forEach((rid, idx) => {
      const result = document.getElementById(rid);
      const textareaId = idx === 0 ? 'text1' : 'text2';
      result.querySelectorAll('.line-number').forEach(ln => {
        ln.style.cursor = 'pointer';
        ln.onclick = function(e) {
          const lineNum = parseInt(this.textContent);
          focusTextareaLine(textareaId, lineNum);
        };
      });
    });
  }
  
  // เรียกหลัง compareText
  const _oldCompareText = compareText;
  compareText = function() {
    _oldCompareText();
    addResultLineClickEvents();
  };
  
  // เรียกครั้งแรก
  updateLineNumbers();

  function showLineHighlight(textareaId, lineNum) {
    const ta = document.getElementById(textareaId);
    const panel = ta.closest('.editor-panel');
    const overlayContainer = panel.querySelector('.textarea-overlay');
    let overlay = overlayContainer.querySelector('.line-highlight');
    if (!overlay) {
      overlay = document.createElement('div');
      overlay.className = 'line-highlight';
      overlayContainer.appendChild(overlay);
    }

    // คำนวณตำแหน่งบรรทัด
    const lineHeight = parseFloat(window.getComputedStyle(ta).lineHeight);
    const paddingTop = parseFloat(window.getComputedStyle(ta).paddingTop) || 0;
    const top = paddingTop + (lineNum - 1) * lineHeight - ta.scrollTop;

    overlay.style.position = 'absolute';
    overlay.style.left = '0';
    overlay.style.right = '0';
    overlay.style.top = top + 'px';
    overlay.style.height = lineHeight + 'px';
    overlay.style.background = 'rgba(0,122,204,0.25)';
    overlay.style.borderRadius = '4px';
    overlay.style.opacity = '1';
    overlay.style.transition = 'opacity 0.2s';

    setTimeout(() => {
      overlay.style.opacity = '0';
    }, 1000);
  }
</script>
</body>
</html>